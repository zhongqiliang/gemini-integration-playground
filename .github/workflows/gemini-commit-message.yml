name: 'Gemini Commit Message Generator'

on:
  pull_request:
    types: [opened, reopened]
  issue_comment:
    types: [created]

jobs:
  generate_commit_message:
    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.comment.body == '/generate-commit-message')

    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write

    steps:
      # --- Step 1: Get PR Diff ---
      - name: 'Get PR Diff'
        id: diff
        run: |
          set -eux
          # Inline Logic: Use pull_request URL if available, otherwise fallback to issue URL
          PR_API_URL="${{ github.event.pull_request.url || github.event.issue.pull_request.url }}"
          
          diff_content=$(curl -fsSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3.diff" "$PR_API_URL")

          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$diff_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- Step 2: Call Gemini API ---
      - name: 'Generate Commit Message with Gemini'
        id: gemini
        # Load data safely into ENV to prevent script injection
        env:
          PR_TITLE: ${{ github.event.pull_request.title || github.event.issue.title }}
          PR_BODY: ${{ github.event.pull_request.body || github.event.issue.body }}
          PR_DIFF: ${{ steps.diff.outputs.diff_content }}
        run: |
          set -eux
          
          SYSTEM_PROMPT="Act as an expert software engineer specializing in the Cobalt codebase (Chromium fork). Generate a professional Git commit message based on the PR details.
          
          Rules:
          1. Tag Prefix: Subject line MUST start with a tag (e.g., 'media:', 'cobalt:').
          2. Subject: Imperative mood, max 50 chars, no period.
          3. Body: Explain 'what' and 'why', wrap at 72 chars.
          4. Output: ONLY the commit message. No markdown backticks.
          
          Tags: android, tvos, build, cobalt, evergreen, linux, media, net, posix, starboard, ci, cleanup, docs, feat, fix, refactor, revert, test."

          # Use jq to handle JSON construction safely
          json_payload=$(jq -n \
            --arg sys "$SYSTEM_PROMPT" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            --arg diff "$PR_DIFF" \
            '{
              contents: [{
                parts: [{
                  text: ($sys + "\n\nPR Title: " + $title + "\n\nPR Description:\n" + $body + "\n\nCode Diff:\n" + $diff)
                }]
              }]
            }')

          api_response=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -d "$json_payload")

          gemini_text_response=$(echo "$api_response" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not parse a valid response from the Gemini API. Please check the API response logs in the workflow run."')

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$gemini_text_response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- Step 3: Post Comment ---
      - name: 'Post Commit Message as Comment'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: |
            ### ðŸ¤– Gemini Suggested Commit Message

            ---

            ```
            ${{ steps.gemini.outputs.response }}
            ```

            ---

            **ðŸ’¡ Pro Tips for a Better Commit Message:**

            1.  **Influence the Result:** The commit message quality is highly dependent on the information provided in the PR description.
            2.  **Re-run the Generator:** Post a comment with: `/generate-commit-message`
        with:
          script: |
            const body = process.env.COMMENT_BODY;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              // Inline Logic: Use PR number if available, otherwise fallback to Issue number
              issue_number: ${{ github.event.pull_request.number || github.event.issue.number }},
              body: body
            });
